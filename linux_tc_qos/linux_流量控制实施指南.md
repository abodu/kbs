## 1. Linux 流量控制思想简介

### 1.1 什么是流量控制

流量控制就是在路由器上通过一系列队列，对数据包进行排序以控制它们的发送顺序，并通过一系列策略控制收到的和发送的数据包是否应该被丢弃，同时还要对数据包的发送速率进行控制。

在大部分情况下，流量控制只有一个队列，接收由本机应用程序产生的数据包把它们放入队列，并以网络硬件所能支持的最大速度发送出去。这种类型的队列叫做FIFO。

不同的应用有不同类型的队列。队列就是一种用于组织未能立即开始的任务或数据流的方法。网络链路通常要求数据包以一定的顺序发送，因此我们需要在本机网络出口上使用队列来管理数据包。

**举个例子说明**：

> 如果一台桌面电脑和一台流量较大的网站服务器共用一条网络链路，那就有可能发生带宽争夺。由于网站服务器的上行流量很大，超过了链路速度，从而路由器上的队列被来自网站服务器的数据包挤满。路由上的队列被挤满后，路由器就会开始丢包，这会导致桌面电脑的丢包率上升，数据延时增大。过大的延时会让桌面用户抓狂的。如果我们把这条链路分成两部分，分别给桌面电脑和网站服务器使用，就能较好地分配带宽资源，让两者都能比较正常地工作。

在Linux下，用户可以通过一系列工具在网络端口上应用不同类型的队列和策略来实施流量控制。这些工具提供的功能都很强大，同时也很复杂。但是，虽然实施流量控制可以改善网络质量，但提高带宽所得到的效果总是优于实施流量控制的。

QoS（Quality of Service，服务质量）通常也被当做是一种实施流量控制的方法。

### 1.2 为什么要实施流量控制

分组(或 `数据包`)交换网络和电路交换网络的一个重要不同之处是，分组交换网络是无状态的，而电路交换网络是有状态的（如电话线路）。分组交换网络被设计成和IP网络一样，是无状态的网络，无状态属性保证了包交换网络的健壮性。

无状态网络的缺点是无法很好地区分网络上的数据流类型。而通过实施流量控制，我们可以根据数据包的类型来决定其发送的方法和顺序，这就可以在无状态网络上模拟出一个有状态网络。

流量控制还可以用于很多网络环境下。下面列出了一些例子，在这些情况下，实施流量控制通常可以解决问题，至少也能把糟糕的情况改善一些。流量控制可用于很多情况，下面的例子并没有完全包括所有的情况。但列出这些例子可以帮助读者了解，在何种情况下实施流量控制可以收到不错的效果。

**常见的流量控制实践**

> - 使用 TBF 和HTB把带宽限制在一个数值之下。
> -  使用 HTB和 classifying，并配合使用filter，限制某个用户、某个服务或某个程序所能使用的带宽。
> - 在非对称线路（如ADSL）上最大化TCP协议的吞吐量。这可以通过提高ACK数据包的优先级来实现。
> - 为某个用户或某个应用保留一定的带宽。这可以通过HTB和classifying来实现。
> - 提高延时敏感性型用的性能。这要通过在HTB内使用PRIO来实现。
> - 合理分配多余的带宽。可以通过HTB的租借机制来实现。
> - 在无限制的网络上实现公平分配资源。这可以通过HTB的租借机制来实现。
> - 丢弃某种类型的数据包。这可以通过policer和filter来实现。

记住，在大多数情况下，购买更多的带宽会比实施流量控制取得更好的效果。实施流量控制并非长久之计。

### 1.3 实施流量控制的优缺点

#### 1.3.1  好处

若能正确地实施流量控制，那就能让网络得到更充分地使用，减少网络上的竞争。大流量的下载不会破坏实时程序的交互性，同时也能让低优先级的数据传输（如电子邮件）正常进行。

更广义上，如果流量控制的策略能很好地符合与用户约定好的网络使用规则，那么用户也就能更合理地使用有限的网络资源。

#### 1.3.2 缺点

复杂性是实施流量控制的一个主要缺点。

> 虽然可以借助一系列工具的帮助来降低实施流量控制的复杂性，但是要想从已经配置好的流量控制方案中找出不恰当的配置也依旧不是一件容易的事情。

正确实施流量控制可以更公平地分配网络资源，但若配置不恰当，可能反而会恶化网络环境，使网络资源的分配更加不公平。

流量控制的规则越多，路由器就要使用更多的处理器资源来处理这些流量控制规则，我们要保证路由器有足够的能力来处理我们所设定的流量控制规则。幸运的是，路由器不需要消耗太多的计算资源就能处理比较复杂的规则。从另一方面来说，我们更应把注意力放在如何保证如此复杂的流量控制规则不会出现错误。

对于个人用户来说，实施流量控制几乎是零成本的。但对于企业来说，实施流量控制所付出的成本可能要比购买更大的带宽还要多，因为雇用一个了解流量控制的员工所需的工资可能比每月的带宽费用还要多。

### 1.4 队列

队列是调度的实现。一个队列中会有有限多个对象，这些对象将在队列中排队等待以便被处理。在网络中，队列中的对象就是**数据包**，数据包在队列中排队等待网卡将它们发送出去。

> 最简单的一种情况是，队列中的数据包按照先进先出规则进行排队，最先进入队列的数据包将会被最先传输出去，而最后进入队列的数据包将被最后传输出去。在计算机网络（或计算机科学）中，这种排队方式就叫做 FIFO.

如果不使用其他组件，单纯的队列无法提供流量控制的功能。队列只有两种操作，当数据包到来时执行入队操作，当有数据包可以发送时执行出队操作。

当队列配合其他组件使用时，就能实现很多的功能。我们可以同时使用多个队列，对数据包进行重排、丢弃、改变优先级等操作。

对运行在高层的应用来说，数据包只要能被发送出去就可以，至于发送顺序如何倒不是很重要。因此，对高层应用来说，流量控制系统就只是一条单一的队列。只有对于流量控制本层来说，流量控制结构才是可见的和有意义的。

### 1.5 数据包和帧

一块数据被称为什么取决于它位于哪一层网络栈中。虽然这里写出了数据包和帧两个名词，但在整个文档中将不会刻意区分这两个词在技术上的区别（这通常是错误的做法！）。

帧通常被用于描述位于第二层（数据链路层）的数据块。以太网接口、PPP接口和T1接口都把位于第二层的数据块称为帧。在这种情况下，帧就是流量控制所要操作的对象。

在其他情况下，位于第三层（网络层）的数据块被称为数据包。虽然不太精确，但本文将会使用数据包这一名词进行说明。

### 1.6 数据流

一个数据流就是两台主机间建立的一条连接。任何经由这条连接发送的一系列数据包都可以看成这两台主机间的一条数据流。

> 在TCP中，源IP和端口及目的IP和端口唯一决定了一条数据流。在UDP中也类似如此。

流量控制可以将网络流量分割成不同类型的数据流，这些数据流可以作为一个整体进行传输（参考DiffServ）。不同的流量控制结构可以将网络流量平均地分割成不同的数据流。

当网络中的数据流发生冲突时，对数据流进行处理就显得非常重要。这种情况常见于一个应用程序产生了大量的数据流时。

### 1.7 令牌桶

在流量整形中，令牌桶算法是一种很常用的整形方法。

为了控制队列中数据包出队的速率，就需要精确计算单位时间内出队的数据包数或数据包总大小，而这通常是很复杂的。为了进行简化，现在一般都使用另一种机制：系统以一定的速率产生令牌，每个数据包（或一个字节）对应一个令牌，只有当令牌充足的时候数据包才能出队。

> 打个比方来说，在游乐园里有很多游客在排队等待乘坐过山车。让我们假设过山车按照固定的时间到来。游客必须等待一列过山车到来后才能乘坐。在这里，过山车上的位置就相当于令牌，而游客就相等于数据包。这就是网络速率限制，或者称为shaping。在单位时间内，只能有固定数量的游客乘上过山车（出队）。

> 继续这个过山车的比喻，假设某个时刻没有游客排队，而车站里有很多车子，这时候来了一大波游客，那么这些游客的大多数人（甚至是全部）都能立刻乘上过山车（因为此时车站里有很多空车）。车站里所能停放的过山车数量就是令牌桶中“桶”的大小。桶中积攒起来的令牌能在突然出现大量数据包时全部使用出去。

> 让我们完成这个比喻。游乐园里的过山车以恒定速率到来，如果没有游客排队的话，就停放在等待区里，直到等待区里停满了车子。在令牌桶模型中，令牌以恒定的速率填充到桶中，直到桶满了为止。使用令牌桶模型进行流量整形能应付诸如HTTP应用之类会产生突发数据传输的情形。

概括来说，系统会以恒定的速率产生令牌，直到令牌桶满了为止。令牌桶能够在保证较长一段时间内网络流量在限制值以下，又能处理大速率的突发数据传输。

令牌桶模型也被应用于TBF（一种classless qdiscs）和HTB（一种classful qdiscs）中。

## 2. 流量控制中的概念

### 2.1 整形

整形就是流量控制，把数据包的发送速率控制在一个固定的水平以下。

这是最常用的流量控制手段。由于整形通过延迟数据包的发送来控制数据包发送速率，故整形机制是非工作保存的。“非工作保存”可以理解为：系统必须进行一些操作来延迟数据包的发送。

反过来说，一种非工作保存的队列是可以进行流量整形的，而工作保存的队列（参考 PRIO）不能进行流量整形，因为工作保存队列无法延迟发送数据包。

流量整形的好处之一是可以控制数据包的延迟时间。
在流量整形中，通常会使用令牌桶机制来实现整形。

### 2.2 调度

一个调度器会对将要发送的数据包顺序进行排列或重排。

对队列中对数据包顺序进行排列或重排就叫做调度。最常见的调度器是FIFO（先入先出队列）。由于数据包必须按顺序出队，因此队列实际上就是一个调度器。

对于不同的网络环境，我们可以使用不同的调度器。

> - 一个公平队列算法（参考SFQ）能防止一个客户端或一个数据流占用过多的带宽。
> - 一个循环算法（参考WRR）可以让各个客户端或数据流都有平等的使用网络的机会。

此外, 还有一些更复杂的算法可用于防止骨干网流量过载，或者是对一些常见算法的改进。

### 2.3 分类

分类器能把不同类型的网络流量划分到不同的队列中去。

把数据包按照不同类型进行划分叫做分类。通常我们只对上行流量进行分类。在路由器接收、路由并转发一个数据包的时候，网络设备可以以几种不同的方式给数据包进行分类。其中一种方式是【标记】数据包。标记数据包的操作可以在一个网络中由管理员进行设置，也有可能在数据包经过每一跳时发生。

Linux允许数据包通过一系列的流量控制结构，期间允许用户使用【决策器】对数据包进行分类。

### 2.4 策略

决策器能计算并限制某个特定队列的流量。

在流量控制中使用决策器来控制流量是非常简单的。决策器通常会应用于网络边界上，某个节点使用的流量不会超过分配给它的流量。当网络流量在预设值以下时，决策器什么都不会做。但当网络流量超过预设值时，决策器就开始发挥作用，它能将流量速率控制在一个固定的水平之下。

> 最不近人情的操作是即使在数据包能够继续[分类]的情况下依旧直接将其[丢弃]。

### 2.5 丢弃

丢弃一个数据包，一个数据流或一个分类下的数据包，都可以叫做丢弃。

> 丢弃一个数据包就叫做丢包。

### 2.6 标记

标记是一种对数据包进行一些修改的操作。

> 这里说的标记不是`fwmark`。

流量控制中的标记操作会给数据包加上一个`DSCP`，接下来在由一个管理员控制的一个网络下的其他路由器上将会使用这个标记。

## 3. Linux 流量控制中的组件

| 概念        | 组件                                                         |
| ----------- | ------------------------------------------------------------ |
| shapping    | [`class`] 提供流量整形功能                                   |
| scheduling  | [`qdisc`] 就是一个调度器                                     |
| classifying | [`filter`] 会附着在[`classifier`] 上进行分类工作。严格来说，分类器必须依靠过滤器才能正常工作。 |
| policing    | [`policer`]可以看成是[`filter`]的一个子功能。                |
| dropping    | 将[`filter`]和[`policer`]配合使用,并将[`policer`]的动作设为"丢包",就可以丢弃指定的数据流。 |
| marking     | `dsmark` [`qdisc`]用于给数据包打上标记。                     |

